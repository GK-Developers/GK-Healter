name: CI

permissions:
  contents: write

on:
  push:
    branches: [master, main, develop]
    tags:
      - "v*"
  pull_request:
    branches: [master, main]

jobs:
  lint:
    name: Lint & Style
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install lint tools
        run: pip install flake8 pycodestyle

      - name: Run flake8
        run: |
          flake8 gk-healter/src/ \
            --max-line-length=120 \
            --ignore=E111,E114,E117,E203,E261,E402,E501,W503 \
            --count --statistics

  validate:
    name: Validate Desktop & AppStream
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y desktop-file-utils appstream-util

      - name: Validate desktop file
        run: desktop-file-validate gk-healter/data/io.github.gkdevelopers.GKHealter.desktop

      - name: Validate AppStream metainfo
        run: appstream-util validate-relax --nonet gk-healter/data/io.github.gkdevelopers.GKHealter.metainfo.xml

  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-gi \
            gir1.2-gtk-3.0 \
            libgirepository1.0-dev \
            libgirepository-2.0-dev \
            gobject-introspection \
            gcc \
            python3-dev \
            libcairo2-dev \
            pkg-config

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov psutil PyGObject

      - name: Run tests with coverage
        env:
          PYTHONPATH: ${{ github.workspace }}/tests:${{ github.workspace }}/gk-healter
        run: |
          pytest tests/ -v --tb=short \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=75

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  deb-package:
    name: Debian Package
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - uses: actions/checkout@v4

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev fakeroot

      - name: Build .deb
        run: |
          cd gk-healter
          make deb

      - name: Upload .deb as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gk-healter-deb
          path: gk-healter/*.deb

  rpm-package:
    name: RPM Package
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - uses: actions/checkout@v4

      - name: Install RPM packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm rpmbuild-wrapper rpm-build-essentials || \
          sudo apt-get install -y rpm rpmlint

      - name: Build .rpm
        run: |
          cd gk-healter
          make rpm

      - name: Upload .rpm as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gk-healter-rpm
          path: gk-healter/*.rpm

  appimage-package:
    name: AppImage Package
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-gi \
            gir1.2-gtk-3.0 \
            libgirepository1.0-dev \
            gobject-introspection \
            python3-dev \
            libcairo2-dev \
            pkg-config \
            fuse \
            libfuse2 \
            desktop-file-utils \
            wget

      - name: Install Python dependencies
        run: pip install psutil PyGObject

      - name: Build AppImage
        run: |
          cd gk-healter
          make appimage

      - name: Upload AppImage as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gk-healter-appimage
          path: gk-healter/*.AppImage

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [deb-package, rpm-package, appimage-package]

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/

      - name: List artifacts
        run: find release-artifacts/ -type f | head -50

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-artifacts/gk-healter-deb/*.deb
            release-artifacts/gk-healter-rpm/*.rpm
            release-artifacts/gk-healter-appimage/*.AppImage
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
